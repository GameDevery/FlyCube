#pragma once

#include <Program/Program.h>
#include <glm/glm.hpp>
#include <array>
#include <vector>

class {{ShaderName}} : public Shader<{{ShaderType}}>
{
public:
    struct
    {
{{#CBuffers}}        struct
        {
{{#Variables}}            {{&Type}} {{Name}};
{{/Variables}}        } {{BufferName}};
{{/CBuffers}}    } cbuffer;

    struct
    {
{{#Textures}}        static constexpr const uint32_t {{Name}} = {{Slot}};
{{/Textures}}    } texture;

    struct
    {
{{#Inputs}}        static constexpr const uint32_t {{Name}} = {{Slot}};
{{/Inputs}}    } geometry;

    {{ShaderName}}(ComPtr<ID3D11Device>& device)
        : Shader(device, "{{ShaderPath}}", "{{Entrypoint}}", "{{Target}}")
        , cbuffer{}  
        , cbuffer_impl(device)     
    {
    }

    virtual void UpdateCBuffers(ComPtr<ID3D11DeviceContext>& device_context) override
    {
        {{#CBuffers}}cbuffer_impl.{{BufferName}}.UpdateCBuffer(device_context, (const char*)&cbuffer.{{BufferName}}); 
        {{/CBuffers}}
    } 
 
private:
    virtual void BindCBuffers(ComPtr<ID3D11DeviceContext>& device_context) override
    {
        {{#CBuffers}}cbuffer_impl.{{BufferName}}.BindCBuffer<{{ShaderType}}>(device_context);
        {{/CBuffers}}
    }
    
    class CBufferImpl
    {
    public:
        {{#CBuffers}}BufferLayout {{BufferName}};
        {{/CBuffers}}
        CBufferImpl(ComPtr<ID3D11Device>& device)
            {{#CBuffers}}{{BufferSeparator}} {{BufferName}}(
                device,
                {{BufferSize}},
                {{BufferIndex}},
                {
                    {{#Variables}}{{VariableSize}}, {{/Variables}}
                },
                {
                    {{#Variables}}offsetof(decltype(cbuffer.{{BufferName}}), {{Name}}), {{/Variables}}              
                },
                {
                    {{#Variables}}{{StartOffset}}, {{/Variables}}
                }
            )
            {{/CBuffers}}
        {
        }
    } cbuffer_impl;
};
