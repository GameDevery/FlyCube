#pragma once

#include <Program/Program.h>
#include <glm/glm.hpp>
#include <array>
#include <vector>

class {{ShaderName}} : public Shader<{{ShaderType}}>
{
public:
    struct
    {
{{#CBuffers}}        struct
        {
{{#Variables}}            {{&Type}} {{Name}};
{{/Variables}}        } {{BufferName}};
{{/CBuffers}}    } cbuffer;

    struct
    {
{{#Textures}}        static constexpr const uint32_t {{Name}} = {{Slot}};
{{/Textures}}    } texture;

    struct
    {
{{#UAVs}}        static constexpr const uint32_t {{Name}} = {{Slot}};
{{/UAVs}}    } uav;

    struct
    {
{{#Inputs}}        static constexpr const uint32_t {{Name}} = {{Slot}};
{{/Inputs}}    } geometry;

    struct
    {
{{#Samplers}}        static constexpr const uint32_t {{Name}} = {{Slot}};
{{/Samplers}}    } sampler;

    {{ShaderName}}(Context& context)
        : Shader(context, "{{ShaderPath}}", "{{Entrypoint}}", "{{Target}}")
        , cbuffer{}  
        , cbuffer_impl(context)     
    {
    }

    virtual void UpdateCBuffers() override
    {
        {{#CBuffers}}cbuffer_impl.{{BufferName}}.UpdateCBuffer((const char*)&cbuffer.{{BufferName}}); 
        {{/CBuffers}}
    } 
 
private:
    virtual void BindCBuffers() override
    {
        {{#CBuffers}}cbuffer_impl.{{BufferName}}.BindCBuffer<{{ShaderType}}>();
        {{/CBuffers}}
    }
    
    class CBufferImpl
    {
    public:
        {{#CBuffers}}BufferLayout {{BufferName}};
        {{/CBuffers}}
        CBufferImpl(Context& context)
            {{#CBuffers}}{{BufferSeparator}} {{BufferName}}(
                context,
                "<{{BufferName}}>",
                {{BufferSize}},
                {{BufferIndex}},
                {
                    {{#Variables}}{{VariableSize}}, {{/Variables}}
                },
                {
                    {{#Variables}}offsetof(decltype(cbuffer.{{BufferName}}), {{Name}}), {{/Variables}}              
                },
                {
                    {{#Variables}}{{StartOffset}}, {{/Variables}}
                }
            )
            {{/CBuffers}}
        {
        }
    } cbuffer_impl;
};
