#pragma once

#include <ProgramApi/Program.h>
#include <glm/glm.hpp>
#include <array>
#include <vector>
#include <memory>

class {{ShaderName}}
{
public:
    ShaderDesc desc;
    static const ShaderType type = {{ShaderType}};

    struct
    {
{{#CBuffers}}        struct
        {
{{#Variables}}            {{&Type}} {{Name}};
{{/Variables}}        } {{BufferName}};
{{/CBuffers}}    } cbuffer;

    struct SRV
    {
        SRV(Context& context)
{{#Textures}}            {{Separator}} {{Name}}(context, type, "{{Name}}", {{Slot}})
{{/Textures}}        {
        }

{{#Textures}}       SRVBinding {{Name}};
{{/Textures}}    } srv;

    struct UAV
    {
        UAV(Context& context)
{{#UAVs}}            {{Separator}} {{Name}}(context, type, "{{Name}}", {{Slot}})
{{/UAVs}}        {
        }

{{#UAVs}}       UAVBinding {{Name}};
{{/UAVs}}    } uav;

    struct IA
    {
{{#Inputs}}        static constexpr const uint32_t {{Name}} = {{Slot}};
{{/Inputs}}    } ia;

    {{#HasOutputs}}
    struct OM
    {
        OM(Context& context)
{{#Outputs}}            {{Separator}} rtv{{Slot}}(context, {{Slot}})
{{/Outputs}}            {{DSVSeparator}} dsv(context)
        {
        }

{{#Outputs}}        RTVBinding rtv{{Slot}};
{{/Outputs}}        DSVBinding dsv;
    } om;
    {{/HasOutputs}}

    struct Sampler
    {
        Sampler(Context& context)
{{#Samplers}}            {{Separator}} {{Name}}(context, type, "{{Name}}", {{Slot}})
{{/Samplers}}        {
        }

{{#Samplers}}       SamplerBinding {{Name}};
{{/Samplers}}    } sampler;

    {{ShaderName}}(ProgramApi& program)
        : desc("{{ShaderPath}}", "{{Entrypoint}}", type)
        , m_program(program)
        , cbuffer{}
        , srv(program.GetContext())
        , uav(program.GetContext())
        {{#HasOutputs}}, om(program.GetContext()) {{/HasOutputs}}
        , sampler(program.GetContext())
        , cbuffer_impl(*this)
    {
        {{#CBuffers}}
        {
            NamedBindKey bind_key = { type, ViewType::kConstantBuffer, {{BufferIndex}}, "{{BufferName}}" };
            m_program.SetCBufferLayout(bind_key, cbuffer_impl.{{BufferName}});
        }
        {{/CBuffers}}
    }

    void UpdateShader()
    {
        shader = m_program.GetContext().CompileShader(desc);
    }

    std::shared_ptr<Shader> shader;

private:
    class CBufferImpl
    {
    public:
        {{#CBuffers}}BufferLayout {{BufferName}};
        {{/CBuffers}}
        CBufferImpl({{ShaderName}}& shader)
            {{#CBuffers}}{{BufferSeparator}} {{BufferName}}(
                (const char*)&shader.cbuffer.{{BufferName}},
                {{BufferSize}},
                {
                    {{#Variables}}{{VariableSize}}, {{/Variables}}
                },
                {
                    {{#Variables}}offsetof(decltype(cbuffer.{{BufferName}}), {{Name}}), {{/Variables}}
                },
                {
                    {{#Variables}}{{StartOffset}}, {{/Variables}}
                }
            )
            {{/CBuffers}}
        {
        }
    } cbuffer_impl;

    ProgramApi& m_program;
};
